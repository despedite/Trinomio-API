<!DOCTYPE html>
<html>
<head>
	<!-- UTF-8 -->
	<meta content="text/html; charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">
	<!-- Favicon y nombre -->
	<link href="img/favicon.png" rel="icon" type="image/png">
	<title>APIHook</title>
	<!-- Iconos de Material Design -->
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<!-- Materialize -->
	<link href="css/materialize.min.css" media="screen,projection" rel="stylesheet" type="text/css">
	<script src="js/jquery-3.4.1.min.js" type="text/javascript">
	</script>
	<!-- Código para avisarle al navegador que es comp. con móviles -->
	<meta content="width=device-width, initial-scale=1.0" name="viewport">
</head>
<body>
	<!-- Barra de Navegación -->
	<nav>
		<div class="nav-wrapper purple darken-2" style="padding: 0px 50px 0px 50px;">
			<a class="brand-logo" href="index.html"><img src="img/logo.png" style="height: 32px; vertical-align: middle; padding-bottom: 7px;"></a>
			<ul class="right hide-on-med-and-down" id="nav-mobile">
				<li>
					<a href="https://github.com/despediteerik/Trinomio-API">Github</a>
				</li>
				<li>
					<a href="index.html">Personas</a>
				</li>
			</ul>
		</div>
	</nav>

	<!-- Tabla (aka la parte divertida) -->
	<!-- Container con width de 90%. Materialize hace muy chico el espacio de los containers para una tabla, -->
	<!-- y añadirle margin a toda la tabla en CSS hace que esta se corra a la izquierda. -->
	<div class="container" style="width: 90%;">
		<!-- La tabla se llena programáticamente en Javascript. -->
		<table border='1' class="responsive-table" id="records_table" style="margin-top:20px;"></table>
	</div>
	<!-- FAB (floating action button). Presionarlo te lleva a el diálogo de Crear una Persona. -->
	<div class="fixed-action-btn">
		<a class="btn-floating btn-large purple darken-1" href="./crear.html"><i class="large material-icons waves-effect waves-light">add</i></a>
	</div>

	<!-- INICIO DE JAVASCRIPT -->
	<script type="text/javascript">
		function showTable() {
			$.getJSON('http://evera.challenge.trinom.io/api/peoples', function(data) {
				var keys = Object.keys(data.data);
				//Reset the data, in case this is executed more than once (E.G. when deleting an user)
				document.getElementById('records_table').innerHTML = '<thead><tr><th>#</th><th>Nombre</th><th>Apellido</th><th>Email</th><th>Cursos</th><th>Acciones</th></tr></thead><tbody>';
				for (var i = 0; i < keys.length; i++) {
					$('<tr class="parent" id="' + data.data[i].id + '">').append($('<td>').text(data.data[i].id), $('<td>').text(data.data[i].first_name), $('<td>').text(data.data[i].last_name), $('<td>').text(data.data[i].email), $('<td><span class="expand btn-floating waves-effect waves-teal btn-flat"><i class="material-icons left icon-black">fullscreen</i></span>'), $('<td><a href="./crear.html?edit=true&id=' + data.data[i].id + '&first_name=' + data.data[i].first_name + '&last_name=' + data.data[i].last_name + '&email=' + data.data[i].email + '"><span class="btn-floating waves-effect waves-teal btn-flat"><i class="material-icons left icon-black">edit</i></span></a> <a onclick="eliminarEntrada(' + "'" + data.data[i].first_name + "'" + ', ' + data.data[i].id + ');"><span class="btn-floating waves-effect waves-teal btn-flat"><i class="material-icons left icon-black">delete</i></span></a>')).appendTo('#records_table');
					var keystwo = Object.keys(data.data[i].courses);
					for (var j = 0; j < keystwo.length; j++) {
						$('<tr class="child-' + data.data[i].id + '">').append($('<td style="background-color:lightgrey">').text(data.data[i].courses[j].id), $('<td colspan="5" style="background-color:lightgrey"> <b>' + data.data[i].courses[j].name + '</b><br>Nivel: ' + data.data[i].courses[j].level.name + '<br><small>' + data.data[i].courses[j].language.name + " (" + data.data[i].courses[j].language.code + ")</small><br> ...") //TODO: removes last line??
						).appendTo('#records_table');
					}
				}
				// TO-DO: Close all on page done loading and NOT on table done loading
				cerrarTodo();
			});
		}

		function eliminarEntrada(strg, id) {
			var url = "http://evera.challenge.trinom.io/api/peoples/" + id;
			$.ajax({
				url: url,
				type: "DELETE",
				data: JSON.stringify({
					"people": id
				}),
				contentType: "application/json",
				dataType: 'json',
				error: function(xhr, status, error) {
					console.log(error);
					console.log(xhr.responseText);
					M.toast({
						html: 'Hay un error en tu solicitud.',
						classes: 'rounded'
					});
				},
				success: function() {
					M.toast({
						html: '¡El usuario "' + strg + '" fue eliminado con éxito!',
						classes: 'rounded'
					});
					showTable();
				} //TO-DO: send them back to index. probably add an alert afterwards
			});
		}

		function cerrarTodo() {
			$('tr[class^=child-]').hide().children('td');
		}
		$(document).ready(function() {
			$(document).on("click", 'tr.parent td span.expand', function() {
				var idOfParent = $(this).parents('tr').attr('id');
				$('tr.child-' + idOfParent).toggle('fast');
				if ($(this).children('i').text() == "fullscreen_exit") $(this).children('i').text("fullscreen")
				else $(this).children('i').text("fullscreen_exit");
			});
		});
		//show table when web page opens
		showTable();
	</script>
	<style type="text/css">
			  i.icon-black {
				  color: black;
			  }
	</style>
	<script src="js/materialize.min.js" type="text/javascript">
	</script>
</body>
</html>